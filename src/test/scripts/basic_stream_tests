#!/bin/bash

. xdapi

TEST_DIR=/tmp/xdtest/basic

wait_for_server

rm -R $TEST_DIR &> /dev/null
set -e

echo -e '*** Test 1. time | log stream\n'

create_stream 'ticktock' 'time | log' 'false'
list_streams
deploy_stream 'ticktock'

echo -e '*** Test 2. time | jdbc stream\n'

create_stream 'timejdbc' 'time | jdbc'

echo -e '*** Test 3. http | file stream\n'

create_stream 'httptofile' "http | file --dir=$TEST_DIR"

# Run, undeploy, redeploy and run again

curl -d blah "$XD_HOST:9000"
result=`cat $TEST_DIR/httptofile.out`
assert_equals 'blah' $result

rm -R $TEST_DIR &> /dev/null
undeploy_stream 'httptofile'

echo 'Redeploying and running again...'

deploy_stream 'httptofile'
list_streams

curl -d blah "$XD_HOST:9000"
result=`cat $TEST_DIR/httptofile.out`
assert_equals 'blah' $result

destroy_stream 'ticktock'
destroy_stream 'httptofile'
destroy_stream 'timejdbc'

echo -e '*** Test 4. tcp | file stream\n'

create_stream 'tcptofile' "tcp --port=21234 --socketTimeout=2000 | file --dir=$TEST_DIR"

echo -en 'blahblah\r\n' | netcat localhost 21234
sleep 2
destroy_stream 'tcptofile'

result=`cat $TEST_DIR/tcptofile.out`
assert_equals 'blahblah' $result

echo -e '*** Test 5. http | filter | file\n'

create_stream 'httpfilter' "http | filter --expression=#jsonPath(payload,'\$.entities.hashtags[*].text').contains('good') \
                                 | json-field-extractor --fieldName=id \
                                 | file --dir=$TEST_DIR"
# Add a tap after the filter
create_stream 'httptap' "tap:stream:httpfilter.json-field-extractor > counter --name=tweets"

# Send some JSON messages only one of which contain the required hashtag 'good'
curl -d '{"id":9,"entities":{"hashtags":[{"text":"good"},{"text":"bad"}],"urls":[]}}' "$XD_HOST:9000"
curl -d '{"id":2,"entities":{"hashtags":[{"text":"blah"},{"text":"blah"}],"urls":[]}}' "$XD_HOST:9000"
curl -d '{"id":3,"entities":{"hashtags":[{"text":"bad"},{"text":"bad"}],"urls":[]}}' "$XD_HOST:9000"

counter=`curl $XDURL/metrics/counters/tweets | grep -o value\":.`
destroy_stream 'httptap'
destroy_stream 'httpfilter'
destroy_metric counters/tweets

result=`cat $TEST_DIR/httpfilter.out`
# We should get the id of the first message
assert_equals '9' $result

# Counter should have counted all three messages
assert_equals 'value":1' $counter

echo -e '\nAll Good :-)\n'

